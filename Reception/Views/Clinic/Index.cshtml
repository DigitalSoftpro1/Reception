@model IEnumerable<Clinic>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}



<div class="container mt-4">
    <div class="stats-grid mb-4">
        <div class="stat-card">
            <div class="stat-icon">👥</div>
            <div class="stat-value" id="totalVisits">0</div>
            <div class="stat-label">إجمالي الزيارات اليوم</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">⏳</div>
            <div class="stat-value" id="waitingList">0</div>
            <div class="stat-label">قائمة الانتظار</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">💰</div>
            <div class="stat-value" id="totalAmount">0</div>
            <div class="stat-label">إجمالي المبالغ (دينار)</div>
        </div>
    </div>

    <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addClinicModal">
        Add Clinic
    </button>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Clinic Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var clinic in Model)
            {
                <tr>
                    <td>@clinic.Name</td>
                    <td>
                        <button type="button" class="btn btn-info btn-sm me-2"
                                onclick="loadTreatments(@clinic.Id, '@clinic.Name')">
                            <i class="bi bi-eye"></i> View Treatments
                        </button>

                        <button type="button" class="btn btn-primary btn-sm add-treatment-btn"
                                data-clinic-id="@clinic.Id"
                                data-clinic-name="@clinic.Name"
                                data-bs-toggle="modal"
                                data-bs-target="#addTreatmentModal">
                            <i class="bi bi-plus"></i> Add Treatment
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="modal fade" id="addClinicModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="AddClinic" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Add Clinic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="ClinicName" class="form-label">Clinic Name</label>
                        <input type="text" class="form-control" id="ClinicName" name="ClinicName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="viewTreatmentsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Treatments for <span id="viewClinicName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="treatmentsList">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addTreatmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="AddTreatment" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Add Treatment to <span id="clinicNameDisplay"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="ClinicId" name="ClinicId">
                    <div class="mb-3">
                        <label for="TreatmentName" class="form-label">Treatment Name</label>
                        <input type="text" class="form-control" id="TreatmentName" name="Name" required>
                    </div>
                    <div class="mb-3">
                        <label for="TreatmentPrice" class="form-label">Price</label>
                        <input type="number" step="0.01" class="form-control" id="TreatmentPrice" name="DefaultPrice" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // تحميل الإحصائيات
    async function loadStats() {
        try {
            const response = await fetch('/Dashboard/GetStats');
            const data = await response.json();
            document.getElementById('totalVisits').innerText = data.totalVisits;
            document.getElementById('waitingList').innerText = data.waitingList;
            document.getElementById('totalAmount').innerText = parseFloat(data.totalAmount).toLocaleString();
        } catch (err) {
            console.error('Error loading stats:', err);
        }
    }
    setInterval(loadStats, 10000);
    loadStats();

    // Add Treatment Modal data
    document.querySelectorAll('.add-treatment-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            document.getElementById('ClinicId').value = this.dataset.clinicId;
            document.getElementById('clinicNameDisplay').innerText = this.dataset.clinicName;
        });
    });

    // View Treatments function
    async function loadTreatments(clinicId, clinicName) {
        document.getElementById('viewClinicName').innerText = clinicName;
        const listContainer = document.getElementById('treatmentsList');
        listContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        try {
            const response = await fetch(`/Clinic/GetTreatments?clinicId=${clinicId}`);
            const data = await response.json();

            if (data.error) {
                listContainer.innerHTML = `<div class="alert alert-danger text-center">${data.error}</div>`;
                return;
            }

            if (!data.length) {
                listContainer.innerHTML = `<div class="alert alert-warning text-center">No treatments found</div>`;
                return;
            }

            let html = '<table class="table table-bordered"><thead><tr><th>Name</th><th>Price</th></tr></thead><tbody>';
            data.forEach(t => {
                html += `<tr><td>${t.name}</td><td>${parseFloat(t.defaultPrice).toFixed(2)}</td></tr>`;
            });
            html += '</tbody></table>';
            listContainer.innerHTML = html;

            var modal = new bootstrap.Modal(document.getElementById('viewTreatmentsModal'));
            modal.show();

        } catch (err) {
            listContainer.innerHTML = '<div class="alert alert-danger">Failed to load treatments</div>';
            console.error(err);
        }
    }
</script>
